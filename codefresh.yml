version: '1.0'
steps:
    build_step:
        type: build
        title: Building Docker Image
        image_name: {{cookiecutter.repo_name}}/{{cookiecutter.repo_name}}
        working_directory: ./
        dockerfile: Dockerfile
        
    unit_test:
        title: Running Unit Tests
        type: composition
        composition:
            version: '2'
            services:
                db:
                    image: postgres
                    environment:
                        POSTGRES_DB: {{cookiecutter.repo_name}}

        composition_candidates:
            test:
                image: ${{build_step}} 
                links:
                    - db
                command: bash -c 'source ~/.venvs/{{cookiecutter.repo_name}}venv/bin/activate && flake8 && (while ! nc -w 1 -z db 5432; do sleep 0.1; done; py.test --strict tests/)'
